boolean success(String message) {
    currentBuild.result = 'SUCCESS'
    echo message
    return false;
}

boolean shouldRun() {
    String message = sh(label: 'Get Commit Message', script: 'git log -1 --pretty=%B', returnStdout: true).trim()

    if (message.matches('.*\\[skip ci].*')) {
        return success('[skip] commit message contains [skip ci]')
    } else if (env.BRANCH_NAME != 'master' && message.matches("^\\[release] 'v.*")) {
        return success('[skip] only build releases on the master branch')
    } else {
        return true
    }
}

void toolSh(String command) {
    container('java-buildtools') {
        sh command
    }
}
def REPORT_URL= "https://qa1.rogers.com/Digital-QE/"
pipeline {
    agent {
        kubernetes {
            yamlFile 'jenkins-agent.yml'
            defaultContainer 'tools'
            podRetention never()
        }
    }
    parameters {
		
		choice(name: 'Browser', choices: ['saucechrome', 'saucefirefox', 'sauceedge', 'saucesafari', 'sauceandroidchrome', 'sauceioschrome'], description: 'Test Browser')
        choice(name: 'Language', choices: ['en', 'fr'], description: 'Test Language')
        string(name: 'ThreadCount', defaultValue: "1", description: 'Number of parallel test sessions')
        choice(name: 'TunnelRequired', choices: ['No', 'Yes'], description: 'Is Sauce Tunnel required? Select No if AUT is public facing')
        string(name: 'Groups', defaultValue: "Sanity", description: 'Groups names separated by comma')
        string(name: 'TestProfile', defaultValue: "RogersForBusiness(R4B)", description: 'Only used for reporting - has no impact on test runs')
        string(name: 'IndividualTests', defaultValue: "", description: "Individual tests to be passed as Test1 Test2 Test3 Test4 and so on ")
        choice(name: 'Environment', choices: ['prod', 'qa3', 'qa5', 'qa7'], description: 'Environment')

    }

    triggers {

        parameterizedCron(env.BRANCH_NAME == 'master' ?'''
                    # leave spaces where you want them around the parameters. They'll be trimmed.
                    # we let the build run with the default name
                    
		    		20 19 * * 1-5 %Browser=saucechrome;Language=en;IndividualTests=Validate_Header_Wireless_Level1_Home_Page;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    30 19 * * 1-5 %Browser=saucechrome;Language=en;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    31 19 * * 1-5 %Browser=saucechrome;Language=fr;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    32 19 * * 1-5 %Browser=saucefirefox;Language=en;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    33 19 * * 1-5 %Browser=saucefirefox;Language=fr;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    34 19 * * 1-5 %Browser=sauceedge;Language=en;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    35 19 * * 1-5 %Browser=sauceedge;Language=fr;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    36 19 * * 1-5 %Browser=saucesafari;Language=en;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    37 19 * * 1-5 %Browser=saucesafari;Language=fr;Groups=Regression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    38 19 * * 1-5 %Browser=sauceandroidchrome;Language=en;Groups=MobileRegression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    39 19 * * 1-5 %Browser=sauceandroidchrome;Language=fr;Groups=MobileRegression;ThreadCount=1;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    #40 16 * * 1-5 %Browser=sauceioschrome;Language=en;Groups=MobileRegression;ThreadCount=2;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)
                    #41 16 * * 1-5 %Browser=sauceioschrome;Language=fr;Groups=MobileRegression;ThreadCount=2;TunnelRequired=No;Environment=prod;TestProfile=RogersForBusiness(R4B)


                  
                ''':'')
    }

    environment {
        SAUCE_USERNAME = credentials('SAUCE_USERNAME')
        SAUCE_ACCESS_KEY = credentials('SAUCE_ACCESS_KEY')
        FTP_SERVER = credentials('FTP_SERVER')
        FTP_USERNAME = credentials('FTP_USERNAME')
        FTP_PASSWORD = credentials('FTP_PASSWORD')

    }
    stages {
        stage('Run CI?') {
            when { expression { shouldRun() } }
            stages {


                stage('Environment Variables') {
                    steps { sh 'env | sort' }
                }
                stage('Credentials') {
                    environment {
                        GITHUB_CREDENTIALS = credentials('github_daws_svc_account')
                        ARTIFACTORY_CREDENTIALS = credentials('artifactory_serv_svc_dawsdev')
                        SONARQUBE_TOKEN = credentials('sonarqube_serv_svc_dawsdev')
                    }
                    steps {

                        toolSh 'github-credentials.sh'
                        toolSh 'artifactory-credentials.sh'
                        toolSh 'sonarqube-credentials.sh'
                    }
                }


                stage('Regression Tests') {
                    steps {
                        script {
                            if(params.IndividualTests.isEmpty())
                                toolSh "gradle sauceTest -PEnvironment=${params.Environment} -Ptest_browser=${params.Browser} -Ptest_language=${params.Language} -Ptest_groupName='${params.Groups}' -Ptest_threadCount=${params.ThreadCount} -PTunnelRequired='${params.TunnelRequired}' -i --stacktrace"
                            else
                                toolSh "gradle sauceTest -PEnvironment=${params.Environment} -Ptest_browser=${params.Browser} -Ptest_language=${params.Language} ${generateTestString(params.IndividualTests)} -Ptest_threadCount=${params.ThreadCount} -PTunnelRequired='${params.TunnelRequired}' -i --stacktrace"

                        }
                    }
                    post {
                        always {
                            junit 'build/test-results/**/*.xml'
                            script {
                                def jobName = "${env.JOB_NAME}"
                                def buildTimeStamp = "${env.BUILD_TIMESTAMP}"
                                def testProfile = "${env.TestProfile}"
                                def destinationFolder=jobName.replaceAll("\\s+", "").replace("digital-qe/","") + "/" +testProfile+"/"+ buildTimeStamp.replaceAll("\\s+", "")+"/"
                                sh label: 'NS upload', script: """ 
                                netstorage-upload.sh /mnt/ns/nskey.pem ./report Digital-QE/
                                """
                                REPORT_URL="${REPORT_URL}"+"/report/"+destinationFolder+"/results.html"
                            }

                        }
                    }
                }


            }
        }
    }

    post {

        success {
            echo "${env.BUILD_URL} has result success"
            office365ConnectorSend message: "Finished ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${REPORT_URL}>)", webhookUrl: 'https://outlook.office.com/webhook/e3556c59-ec6f-42ad-b0e7-7e48d22625f9@0ab4cbbf-4bc7-4826-b52c-a14fed5286b9/JenkinsCI/5d661927cebd40b7aa69763ce38023d4/151ebd21-71c4-47a1-b389-3a13bf9ccbf1', status: "SUCCESS"
            office365ConnectorSend message: "Finished ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${REPORT_URL}>)", webhookUrl: 'https://rcirogers.webhook.office.com/webhookb2/fc1cf214-7905-48f5-a928-363057789435@0ab4cbbf-4bc7-4826-b52c-a14fed5286b9/IncomingWebhook/8749aee2085b4f79acd771fa946778ea/79e29d92-4686-45ef-81a6-f2d1cc6ac806', status: "SUCCESS"
        }
        failure {
            echo "${env.BUILD_URL} has result fail"
            office365ConnectorSend message: "Finished ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${REPORT_URL}>)", webhookUrl: 'https://outlook.office.com/webhook/e3556c59-ec6f-42ad-b0e7-7e48d22625f9@0ab4cbbf-4bc7-4826-b52c-a14fed5286b9/JenkinsCI/5d661927cebd40b7aa69763ce38023d4/151ebd21-71c4-47a1-b389-3a13bf9ccbf1', status: "FAIL"
            office365ConnectorSend message: "Finished ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${REPORT_URL}>)", webhookUrl: 'https://rcirogers.webhook.office.com/webhookb2/fc1cf214-7905-48f5-a928-363057789435@0ab4cbbf-4bc7-4826-b52c-a14fed5286b9/IncomingWebhook/8749aee2085b4f79acd771fa946778ea/79e29d92-4686-45ef-81a6-f2d1cc6ac806', status: "FAIL"
        }
        unstable {
            echo "${env.BUILD_URL} is unstable"
            office365ConnectorSend message: "Finished ${env.JOB_NAME} build #${env.BUILD_NUMBER} (<${REPORT_URL}>)", webhookUrl: 'https://outlook.office.com/webhook/e3556c59-ec6f-42ad-b0e7-7e48d22625f9@0ab4cbbf-4bc7-4826-b52c-a14fed5286b9/JenkinsCI/5d661927cebd40b7aa69763ce38023d4/151ebd21-71c4-47a1-b389-3a13bf9ccbf1', status: "UNSTABLE"
            office365ConnectorSend message: "Finished ${env.JOB_NAME} build #${env.BUILD_NUMBER} (<${REPORT_URL}>)", webhookUrl: 'https://rcirogers.webhook.office.com/webhookb2/fc1cf214-7905-48f5-a928-363057789435@0ab4cbbf-4bc7-4826-b52c-a14fed5286b9/IncomingWebhook/8749aee2085b4f79acd771fa946778ea/79e29d92-4686-45ef-81a6-f2d1cc6ac806', status: "UNSTABLE"
        }
    }
}

String generateTestString(String tests) {
    tests =tests.trim();
    String[] strArray=tests.split(" ");
    String finalTestString="";
    for (int i=0;i<=strArray.length-1;i++){
        finalTestString=finalTestString+"--tests '"+strArray[i].replace(".java","")+"' ";
    }
    return finalTestString;
}
